<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GraphLib — Troubleshooting</title>

  <!-- Bootstrap 5 (CSS) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />

  <!-- Bootstrap Icons (optional) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" />

<link rel="stylesheet" href="style.css">
</head>

<body>
  <nav class="navbar navbar-expand-lg bg-white border-bottom sticky-top">
    <div class="container">
      <span class="navbar-brand brand fw-semibold">
        <i class="bi bi-life-preserver me-2 text-primary"></i>
        GraphLib Troubleshooting
      </span>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-secondary btn-sm" id="btnExpandAll" type="button">
          <i class="bi bi-arrows-angle-expand me-1"></i>Expand all
        </button>
        <button class="btn btn-outline-secondary btn-sm" id="btnCollapseAll" type="button">
          <i class="bi bi-arrows-angle-contract me-1"></i>Collapse all
        </button>
        <button class="btn btn-primary btn-sm" id="btnPrint" type="button">
          <i class="bi bi-printer me-1"></i>Print
        </button>
      </div>
    </div>
  </nav>

  <header class="py-4">
    <div class="container">
      <div class="row g-3 align-items-stretch">
        <div class="col-12 col-lg-8">
          <div class="card h-100">
            <div class="card-body">
              <h1 class="h3 mb-2">Common Issues & Fixes</h1>
              <p class="mb-0 text-secondary">
                This guide covers the most common setup and runtime issues when running
                <span class="kbd">GraphLib</span> (app-only Microsoft Graph → SharePoint upload + PDF conversion),
                including the exact fix we hit: <span class="badge badge-soft">401 on resolveSite</span> due to missing
                <b>admin consent</b>.

                Use <span class="badge badge-soft">
                  <a href="GettingStarted.html">Getting Started</a>
                </span> for initial setup.
              </p>
            </div>
          </div>
        </div>
        <div class="col-12 col-lg-4">
          <div class="card h-100">
            <div class="card-body">
              <div class="d-flex align-items-center gap-2 mb-2">
                <i class="bi bi-check2-circle text-success fs-5"></i>
                <h2 class="h6 mb-0">Quick Win Checklist</h2>
              </div>
              <ul class="mb-0 small">
                <li>Use <b>Application</b> permissions (not Delegated)</li>
                <li>Click <b>Grant admin consent</b> for the tenant</li>
                <li><span class="kbd">SiteUrl</span> must be the site (not library path)</li>
                <li><span class="kbd">LibraryName</span> must match the library display name</li>
                <li>Use secret <b>Value</b>, not <b>Secret ID</b></li>
                <li>Ensure you’re editing the same SQLite DB you run against</li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <div class="row g-3 mt-1">
        <div class="col-12">
          <div class="callout callout-success">
            <div class="d-flex align-items-start gap-2">
              <i class="bi bi-lightbulb-fill text-success mt-1"></i>
              <div>
                <div class="fw-semibold">Recommended workflow</div>
                <div class="small-muted">
                  Build → init DB → update <span class="kbd">AppSettings</span> → PowerShell site test → run GraphLib.
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </header>

  <main class="pb-5">
    <div class="container">
      <div class="row g-3">
        <div class="col-12 col-lg-4">
          <div class="card">
            <div class="card-body toc">
              <div class="d-flex align-items-center gap-2 mb-2">
                <i class="bi bi-list-task text-primary"></i>
                <h2 class="h6 mb-0">Contents</h2>
              </div>
              <ol class="mb-0 small">
                <li><a href="#t401">401 Unauthorized on resolveSite</a></li>
                <li><a href="#msal">MSAL token/ClientId errors</a></li>
                <li><a href="#siteurl">SiteUrl points to a library/folder</a></li>
                <li><a href="#drive">LibraryName / resolveDrive failures</a></li>
                <li><a href="#sqlite">SQLite updates don’t “stick”</a></li>
                <li><a href="#dbpath">Confirm which DB GraphLib uses</a></li>
                <li><a href="#doit">Minimum “success” checklist</a></li>
              </ol>
              <hr />
              <div class="small-muted">
                Tip: each section includes copy buttons for commands/snippets.
              </div>
            </div>
          </div>
        </div>

        <div class="col-12 col-lg-8">
          <div class="accordion" id="accordionTroubleshooting">

            <!-- 1) 401 resolveSite -->
            <div class="accordion-item" id="t401">
              <h2 class="accordion-header">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#c401"
                  aria-expanded="true">
                  <span class="me-2 status-pill text-danger"><i class="bi bi-shield-x me-1"></i>401</span>
                  Unauthorized on <span class="kbd ms-1">resolveSite</span> (app-only)
                </button>
              </h2>
              <div id="c401" class="accordion-collapse collapse show" data-bs-parent="#accordionTroubleshooting">
                <div class="accordion-body">
                  <div class="callout callout-danger mb-3">
                    <div class="fw-semibold">Most common root cause</div>
                    <div class="small-muted">
                      API permissions exist but are <b>Not granted</b>. You must click <b>Grant admin consent</b> for
                      the tenant.
                    </div>
                  </div>

                  <h3 class="h6">Symptoms</h3>
                  <ul class="small">
                    <li>GraphLib fails at stage <span class="kbd">resolveSite</span>.</li>
                    <li>Event log shows <span class="kbd">statusCode: 401</span>.</li>
                    <li>PowerShell app-only test also returns 401 for a SharePoint Graph endpoint.</li>
                  </ul>

                  <h3 class="h6">Fix</h3>
                  <ol class="small">
                    <li>Azure Portal → <b>Microsoft Entra ID</b> → <b>App registrations</b> → your app</li>
                    <li>Go to <b>API permissions</b></li>
                    <li>Ensure you have <b>Application</b> permissions like:
                      <ul>
                        <li><span class="kbd">Sites.Read.All</span> (minimum)</li>
                        <li>or <span class="kbd">Sites.ReadWrite.All</span> (upload/delete)</li>
                      </ul>
                    </li>
                    <li>Click <b>Grant admin consent</b> (top of the permissions page)</li>
                    <li>Wait ~30–60 seconds and retry</li>
                  </ol>

                  <h3 class="h6">Verification (PowerShell)</h3>
                  <div class="code-wrap">
                    <button class="btn btn-sm btn-outline-primary copy-btn" data-copy="#ps401">
                      <i class="bi bi-clipboard me-1"></i>Copy
                    </button>
                    <pre class="bg-light border rounded p-3 mb-0"><code id="ps401">$tenantId = "&lt;TENANT_ID&gt;"
$clientId = "&lt;CLIENT_ID&gt;"
$clientSecret = "&lt;CLIENT_SECRET_VALUE&gt;" # value, not secret id

$body = @{
  client_id     = $clientId
  scope         = "https://graph.microsoft.com/.default"
  client_secret = $clientSecret
  grant_type    = "client_credentials"
}

$tokenResp = Invoke-RestMethod -Method Post `
  -Uri "https://login.microsoftonline.com/$tenantId/oauth2/v2.0/token" `
  -ContentType "application/x-www-form-urlencoded" `
  -Body $body

$accessToken = $tokenResp.access_token
$headers = @{ Authorization = "Bearer $accessToken" }

Invoke-RestMethod -Method Get `
  -Uri "https://graph.microsoft.com/v1.0/sites/&lt;tenant&gt;.sharepoint.com:/sites/&lt;SiteName&gt;" `
  -Headers $headers</code></pre>
                  </div>

                  <div class="small-muted mt-2">
                    Expected: <b>200 OK</b> and a JSON site payload.
                  </div>
                </div>
              </div>
            </div>

            <!-- 2) MSAL -->
            <div class="accordion-item" id="msal">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                  data-bs-target="#cmsal">
                  <i class="bi bi-key me-2 text-warning"></i>
                  MSAL errors (invalid application identifier / secret)
                </button>
              </h2>
              <div id="cmsal" class="accordion-collapse collapse" data-bs-parent="#accordionTroubleshooting">
                <div class="accordion-body">
                  <div class="callout callout-warning mb-3">
                    <div class="fw-semibold">What to store in SQLite</div>
                    <div class="small-muted">
                      <b>ClientSecret</b> must be the <b>Value</b> shown when you create the secret — not the <b>Secret
                        ID</b>.
                    </div>
                  </div>

                  <h3 class="h6">Symptoms</h3>
                  <ul class="small">
                    <li><span class="kbd">MsalServiceException</span></li>
                    <li>Messages like: “not a valid application identifier”</li>
                  </ul>

                  <h3 class="h6">Fix</h3>
                  <ul class="small">
                    <li><b>TenantId</b> = Directory (tenant) ID</li>
                    <li><b>ClientId</b> = Application (client) ID</li>
                    <li><b>ClientSecret</b> = Secret <b>Value</b></li>
                  </ul>

                  <h3 class="h6">SQLite update example</h3>
                  <div class="code-wrap">
                    <button class="btn btn-sm btn-outline-primary copy-btn" data-copy="#sqlmsal">
                      <i class="bi bi-clipboard me-1"></i>Copy
                    </button>
                    <pre class="bg-light border rounded p-3 mb-0"><code id="sqlmsal">UPDATE AppSettings SET
  TenantId = '&lt;TENANT_ID&gt;',
  ClientId = '&lt;CLIENT_ID&gt;',
  ClientSecret = '&lt;CLIENT_SECRET_VALUE&gt;'
WHERE Id = 1;</code></pre>
                  </div>
                </div>
              </div>
            </div>

            <!-- 3) SiteUrl -->
            <div class="accordion-item" id="siteurl">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                  data-bs-target="#csiteurl">
                  <i class="bi bi-link-45deg me-2 text-primary"></i>
                  SiteUrl is wrong (points to library/folder path)
                </button>
              </h2>
              <div id="csiteurl" class="accordion-collapse collapse" data-bs-parent="#accordionTroubleshooting">
                <div class="accordion-body">
                  <h3 class="h6">Rule</h3>
                  <p class="small mb-2">
                    <span class="kbd">SiteUrl</span> must point to the <b>SharePoint site</b>, not the document library
                    or a folder.
                  </p>

                  <div class="row g-3">
                    <div class="col-12 col-md-6">
                      <div class="callout callout-danger">
                        <div class="fw-semibold mb-1">Incorrect</div>
                        <div class="kbd small">https://tenant.sharepoint.com/sites/SiteName/GraphLib</div>
                      </div>
                    </div>
                    <div class="col-12 col-md-6">
                      <div class="callout callout-success">
                        <div class="fw-semibold mb-1">Correct</div>
                        <div class="kbd small">https://tenant.sharepoint.com/sites/SiteName</div>
                      </div>
                    </div>
                  </div>

                  <h3 class="h6 mt-3">Why</h3>
                  <p class="small mb-0">
                    GraphLib resolves the site via Graph using:
                    <span class="kbd">/sites/{hostname}:{server-relative-path}</span>
                    which expects the site path (e.g., <span class="kbd">/sites/AlphaOmega</span>), not a deeper
                    library/folder URL.
                  </p>
                </div>
              </div>
            </div>

            <!-- 4) resolveDrive -->
            <div class="accordion-item" id="drive">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                  data-bs-target="#cdrive">
                  <i class="bi bi-folder2-open me-2 text-secondary"></i>
                  LibraryName / resolveDrive failures
                </button>
              </h2>
              <div id="cdrive" class="accordion-collapse collapse" data-bs-parent="#accordionTroubleshooting">
                <div class="accordion-body">
                  <h3 class="h6">Symptoms</h3>
                  <ul class="small">
                    <li><span class="kbd">resolveSite</span> succeeds</li>
                    <li>Fails at <span class="kbd">resolveDrive</span></li>
                    <li>Error mentions drive/library not found</li>
                  </ul>

                  <h3 class="h6">Fix</h3>
                  <p class="small mb-2">
                    <span class="kbd">LibraryName</span> must match the document library’s <b>display name</b> in
                    SharePoint.
                    Common names include <span class="kbd">Documents</span> or <span class="kbd">Shared
                      Documents</span>, or your custom name (e.g., <span class="kbd">GraphLib</span>).
                  </p>

                  <h3 class="h6">Tip</h3>
                  <p class="small mb-0">
                    Open the site in the browser, click the library in the left navigation, and use that exact title for
                    <span class="kbd">LibraryName</span>.
                  </p>
                </div>
              </div>
            </div>

            <!-- 5) SQLite updates -->
            <div class="accordion-item" id="sqlite">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                  data-bs-target="#csqlite">
                  <i class="bi bi-database me-2 text-success"></i>
                  SQLite updates don’t “stick” (viewer doesn’t commit / refresh)
                </button>
              </h2>
              <div id="csqlite" class="accordion-collapse collapse" data-bs-parent="#accordionTroubleshooting">
                <div class="accordion-body">
                  <p class="small mb-2">
                    Some SQLite viewers don’t commit edits, or the data grid doesn’t refresh after running SQL.
                    GraphLib’s DB is small and portable — it’s often easiest to update it via scripts.
                  </p>

                  <div class="callout mb-3">
                    <div class="fw-semibold">Recommended</div>
                    <div class="small-muted">
                      Use the repo’s batch-based SQL runner to apply scripts and get a clean success/failure signal.
                    </div>
                  </div>

                  <h3 class="h6">Run an update script</h3>
                  <div class="code-wrap">
                    <button class="btn btn-sm btn-outline-primary copy-btn" data-copy="#runsql1">
                      <i class="bi bi-clipboard me-1"></i>Copy
                    </button>
                    <pre
                      class="bg-light border rounded p-3 mb-0"><code id="runsql1">.\RunBat\run-sql.bat ".\RunBat\update-settings.sql"</code></pre>
                  </div>

                  <h3 class="h6 mt-3">Verify values</h3>
                  <div class="code-wrap">
                    <button class="btn btn-sm btn-outline-primary copy-btn" data-copy="#runsql2">
                      <i class="bi bi-clipboard me-1"></i>Copy
                    </button>
                    <pre
                      class="bg-light border rounded p-3 mb-0"><code id="runsql2">.\RunBat\run-sql.bat "SELECT SiteUrl, LibraryName, TenantId, ClientId FROM AppSettings WHERE Id=1;"</code></pre>
                  </div>
                </div>
              </div>
            </div>

            <!-- 6) DB path -->
            <div class="accordion-item" id="dbpath">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                  data-bs-target="#cdbpath">
                  <i class="bi bi-signpost-split me-2 text-info"></i>
                  Confirm which DB GraphLib is using
                </button>
              </h2>
              <div id="cdbpath" class="accordion-collapse collapse" data-bs-parent="#accordionTroubleshooting">
                <div class="accordion-body">
                  <p class="small mb-2">
                    Relative DB paths are resolved relative to the executable folder. To avoid confusion,
                    always run with an explicit DB path during troubleshooting.
                  </p>

                  <h3 class="h6">Recommended run command</h3>
                  <div class="code-wrap">
                    <button class="btn btn-sm btn-outline-primary copy-btn" data-copy="#runexplicit">
                      <i class="bi bi-clipboard me-1"></i>Copy
                    </button>
                    <pre class="bg-light border rounded p-3 mb-0"><code id="runexplicit">dotnet run -c Release --project .\src\GraphLib.Console\GraphLib.Console.csproj -- run `
  --db ".\src\GraphLib.Console\bin\Release\net8.0\Data\GraphLib.db" `
  --file "C:\path\input.docx"</code></pre>
                  </div>

                  <div class="small-muted mt-2">
                    Tip: Keep your SQL runner pointed at the same DB file you pass to <span class="kbd">--db</span>.
                  </div>
                </div>
              </div>
            </div>

            <!-- 7) Success checklist -->
            <div class="accordion-item" id="doit">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                  data-bs-target="#cdoit">
                  <i class="bi bi-clipboard2-check me-2 text-success"></i>
                  Minimum “success” checklist
                </button>
              </h2>
              <div id="cdoit" class="accordion-collapse collapse" data-bs-parent="#accordionTroubleshooting">
                <div class="accordion-body">
                  <ul class="small mb-0">
                    <li>✅ App Registration exists in tenant</li>
                    <li>✅ Graph <b>Application</b> permissions added (Sites.Read.* / Sites.ReadWrite.*)</li>
                    <li>✅ <b>Admin consent granted</b> for tenant</li>
                    <li>✅ <span class="kbd">TenantId</span> / <span class="kbd">ClientId</span> / <span
                        class="kbd">ClientSecret (Value)</span> stored in SQLite</li>
                    <li>✅ <span class="kbd">SiteUrl</span> points to the SharePoint site (not library/folder)</li>
                    <li>✅ <span class="kbd">LibraryName</span> matches SharePoint library display name</li>
                    <li>✅ You run against the same SQLite DB you update</li>
                  </ul>
                </div>
              </div>
            </div>

          </div><!-- /accordion -->
        </div><!-- /col -->
      </div><!-- /row -->
    </div><!-- /container -->
  </main>

  <footer class="py-4 border-top bg-white">
    <div class="container">
      <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
        <div class="small text-secondary">
          GraphLib Troubleshooting • Generated for your repo docs
        </div>
        <div class="small">
          <a class="anchor-link" href="#top" onclick="window.scrollTo({top:0,behavior:'smooth'}); return false;">
            Back to top <i class="bi bi-arrow-up"></i>
          </a>
        </div>
      </div>
    </div>
  </footer>

  <!-- Bootstrap 5 (JS Bundle includes Popper) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"></script>

  <script src="app.js"> </script>
</body>

</html>